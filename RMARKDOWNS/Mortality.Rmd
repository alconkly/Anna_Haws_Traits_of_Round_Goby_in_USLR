---
title: "Mortality"
author: "Anna Haws"
date: "2024-08-19"
output: html_document
---

# ***Fast Life-Pace and Enhanced Body Size: Traits of an Established, Freshwater Round Goby Population in the Upper St. Lawrence River***
## **Anna L. Haws, John M. Farrell**

### *Mortality analysis*

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(magrittr)
library(plyr)
library(tidyr)
library(FSA)
library(nlstools)
```

```{r}
# Load fully processed dataset

RG <- read_excel("G:/Dissertation/Chapter 4- VHSV demographic/Anna_Haws_Traits_of_Round_Goby_in_USLR/Data/DISSECTED.xlsx") 

RG %<>% filter(!is.na(RG$Age))
RG %<>% filter(Sex != "I")
RG %<>% group_by(Age, Sex) 


RGCounts<- RG %>% dplyr::count(Age, Sex, sort = TRUE)
```

#### A=Annual mortality

#### S= Annual Survival

#### Z=instantaneous mortality rate

$$\ A+S=1 $$ $$\ A=\frac{C_{t}-C_{t+1}}{C_{t}}=1-\frac{C_{t+1}}{C_{t}}$$ $$\ Z=log(C_{t})-log(C_{t+1})$$ $$\ A=1-e^{-Z} $$

## Linear regression fitting, survival estimate, and statistical comparisons between sexes

```{r, echo=FALSE}
RGCounts_3<- filter(RGCounts, Age>=3)
RGCounts_3$lnct<- log(RGCounts_3$n)

lmCC_sex<- lm(Age~lnct*Sex, data=RGCounts_3)
summary(lmCC_sex)
anova(lmCC_sex)
```




## Chapman-Robson Metric estimation and catch curve

Estimates Annual Survival Rate using:

$$\widehat{S}= \frac{T}{n+T-1}=\frac{\overline{T}}{1+\overline{T}-\frac{1}{n}}$$

### All gobies combined
```{r, echo=FALSE}
RG_cr <- chapmanRobson(n~Age,data=RGCounts,ages2use=3:5)
Measure<- c("S", "Z")
AllRG_CR<-cbind(summary(RG_cr, digits=2), confint(RG_cr, digits=2))
(AllRG_CR<- data.frame(Measure, AllRG_CR))


RG_CC<- catchCurve(n~Age, data=RGCounts, ages2use =3:5, weighted = TRUE)
plot(RG_CC, pos.est = "bottomleft")
Measure<- c("Z", "A")
(RG_CC<- cbind(summary(RG_CC, digits=2), confint(RG_CC, digits=2)))
(AllRG_CC<- data.frame(Measure, RG_CC))
AllRG_CC<- AllRG_CC[2,]
AllRG_CC<- AllRG_CC[-c(4,5)]

(AllRG_Mortality_table<- rbind(AllRG_CR, AllRG_CC))

```



#### Plot

```{r, echo=FALSE}

(Mortality_plot<-ggplot(data=RGCounts, aes(x=Age, y=log(n))) + geom_point(aes(colour=Sex)) + ylim(0,5) + stat_smooth( method = lm, se=FALSE, aes(colour=Sex), data = RGCounts_3) + scale_colour_manual(values=c("black", "grey")) + labs(x= "Age", y="Log(Catch [n])")+ theme_classic() + theme( legend.position = "bottom", text=element_text(size=12), legend.margin=margin(-10, 0, 0, 0)) )


Mortality_plot %>% ggsave(filename="Mortality_plot.tiff", device = "tiff", path="G:/POP_STRUCTURE_PUB/Figures/Resized_TIFFs", dpi="retina", width = 90, height = 90, units="mm")
```
